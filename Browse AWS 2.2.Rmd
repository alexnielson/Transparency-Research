---
title: "Browse AWS 2.2"
author: "Michael Jensen"
date: "August 2018"
output: html_notebook
---
# Program Description

Browse the AWS Transparency database.

* Note: The following tables have been replaced by the Transaction_group Table and are no longer used:
  + cat_summary
  + category
  + fund
  + fund_summary
  + org_summary
  + organization

# Program

## Packages & Data Connections

```{r, message = FALSE}
library(magrittr)
library(odbc)
library(tidyverse)

odbc_aws <- dbConnect(odbc::odbc(), "transpAWS")
```

## Transparency Tables

### Admin Email Table

```{sql, connection = odbc_aws, output.var = "sample_admin_email_table"}
SELECT *
FROM admin_email
LIMIT 25
```

### Batch Table

```{sql, connection = odbc_aws, output.var = "entity_batch_all"}
SELECT *
FROM batch
WHERE entity_id = ?transparency_id
```

```{sql, connection = odbc_aws, output.var = "entity_batch_x"}
SELECT *
FROM batch
WHERE id = ?batch_id
```

```{sql, connection = odbc_aws, output.var = "sample_batch_table"}
SELECT *
FROM batch
LIMIT 25
```

### Cat Summary Table (no longer in use)

```{sql, connection = odbc_aws, output.var = "sample_cat_summary_table"}
SELECT *
FROM cat_summary
LIMIT 25
```

### Category Table (no longer in use)

```{sql, connection = odbc_aws, output.var = "sample_category_table"}
SELECT *
FROM category
LIMIT 25
```

### Certification Table

```{sql, connection = odbc_aws, output.var = "sample_certification_table"}
SELECT *
FROM certification
LIMIT 25
```

### CMS Content Table

```{sql, connection = odbc_aws, output.var = "sample_cms_content_table"}
SELECT *
FROM cms_content
LIMIT 25
```

### Contact Table

```{sql, connection = odbc_aws, output.var = "t_contact_table"}
SELECT id, name, email, phone, street, city, zip
FROM contact
```

```{sql, connection = odbc_aws, output.var = "entity_primary_contact"}
SELECT entity.name AS entity_name, 
       contact.id, contact.name, contact.email, contact.phone, contact.street,
       contact.city, contact.zip
FROM contact
LEFT JOIN entity ON contact.id = entity.primary_contact_id
WHERE entity.id = ?transparency_id
```

```{sql, connection = odbc_aws, output.var = "sample_contact_table"}
SELECT *
FROM contact
LIMIT 25
```

### Entity Table

```{sql, connection = odbc_aws, output.var = "t_entity_table"}
SELECT id, name, govt_lvl, fiscal_period, payroll_period
FROM entity
```

```{sql, connection = odbc_aws, output.var = "entity_entity_info"}
SELECT id, name, govt_lvl, fiscal_period, payroll_period
FROM entity
WHERE id = ?transparency_id
```

```{sql, connection = odbc_aws, output.var = "sample_entity_table"}
SELECT *
FROM entity
LIMIT 25
```

### Entity Admin Table

```{sql, connection = odbc_aws, output.var = "sample_entity_admin_table"}
SELECT *
FROM entity_admin
LIMIT 25
```

### Export Request Table

```{sql, connection = odbc_aws, output.var = "sample_export_request_table"}
SELECT *
FROM export_request
LIMIT 25
```

### Function Summary Table

```{sql, connection = odbc_aws, output.var = "sample_function_summary_table"}
SELECT *
FROM function_summary
LIMIT 25
```

### Fund Table (no longer in use)

```{sql, connection = odbc_aws, output.var = "sample_fund_table"}
SELECT *
FROM fund
LIMIT 25
```

### Fund Summary Table (no longer in use)

```{sql, connection = odbc_aws, output.var = "sample_fund_summary_table"}
SELECT *
FROM fund_summary
LIMIT 25
```

### Government Function Table

```{sql, connection = odbc_aws, output.var = "sample_government_function_table"}
SELECT *
FROM government_function
LIMIT 25
```

### Government Level Table

```{sql, connection = odbc_aws, output.var = "sample_government_level_table"}
SELECT *
FROM government_level
LIMIT 25
```

### Government Program Table

```{sql, connection = odbc_aws, output.var = "sample_government_program_table"}
SELECT *
FROM government_program
LIMIT 25
```

### Invalid Uploaded Rows Table

```{sql, connection = odbc_aws, output.var = "sample_invalid_uploaded_rows_table"}
SELECT *
FROM invalid_uploaded_rows
LIMIT 25
```

### Org Summary Table (no longer in use)

```{sql, connection = odbc_aws, output.var = "sample_org_summary_table"}
SELECT *
FROM org_summary
LIMIT 25
```

### Organization Table (no longer in use)

```{sql, connection = odbc_aws, output.var = "sample_organization_table"}
SELECT *
FROM organization
LIMIT 25
```

### Program Summary Table

```{sql, connection = odbc_aws, output.var = "sample_program_summary_table"}
SELECT *
FROM program_summary
LIMIT 25
```

### Summary Table 

```{sql, connection = odbc_aws, output.var = "sample_summary_table"}
SELECT *
FROM summary
LIMIT 25
```

### Transaction Table

*Restricting the following queries by using "AND status IN ('PROCESSED', PROCESSING')" in the Batch Table subquery did not return a different number of records. I assume, therefore, that the transactions of deleted batches are either masked or removed from the Transaction Table.*

#### All Transactions

```{sql, connection = odbc_aws, output.var = "entity_transactions_all"}
SELECT *
FROM transaction
WHERE batch_id IN (
  SELECT id
  FROM batch
  WHERE entity_id = ?transparency_id)
```

```{sql, connection = odbc_aws, output.var = "sample_transaction_table"}
SELECT *
FROM transaction
LIMIT 25
```

#### Expenses

```{sql, connection = odbc_aws, output.var = "entity_transactions_exp"}
SELECT *
FROM transaction
WHERE batch_id IN (
  SELECT id
  FROM batch
  WHERE entity_id = ?transparency_id)
AND type = 1
```

#### Revenues

```{sql, connection = odbc_aws, output.var = "entity_transactions_rev"}
SELECT *
FROM transaction
WHERE batch_id IN (
  SELECT id
  FROM batch
  WHERE entity_id = ?transparency_id)
AND type = 2
```

#### W-2 Employee Compensation

```{sql, connection = odbc_aws, output.var = "entity_transactions_w2"}
SELECT *
FROM transaction
WHERE batch_id IN (
  SELECT id
  FROM batch
  WHERE entity_id = ?transparency_id)
AND type = 3
```

### Transaction Group Table

```{sql, connection = odbc_aws, output.var = "t_transaction_group_table"}
SELECT *
FROM transaction_group
```

```{sql, connection = odbc_aws, output.var = "sample_transaction_group_table"}
SELECT *
FROM transaction_group
LIMIT 25
```

### Vendor Table

```{sql, connection = odbc_aws, output.var = "sample_vendor_table"}
SELECT *
FROM vendor
LIMIT 25
```

### Vendor Summary Table

```{sql, connection = odbc_aws, output.var = "sample_vendor_summary_table"}
SELECT *
FROM vendor_summary
LIMIT 25
```

### Row Count

```{sql, connection = odbc_aws, output.var = "count_batch"}
SELECT COUNT(*) FROM batch
```

```{sql, connection = odbc_aws, output.var = "count_entity"}
SELECT COUNT(*)
FROM entity
```

```{sql, connection = odbc_aws, output.var = "count_transactions"}
SELECT COUNT(*) FROM transaction
```

```{sql, connection = odbc_aws, output.var = "count_deleted_batches"}
SELECT COUNT(*) FROM batch WHERE status = 'DELETED'
```

```{sql, connection = odbc_aws, output.var = "count_deleted_transactions"}
SELECT COUNT(*) 
FROM transaction 
WHERE batch_id IN (
  SELECT id
  FROM batch
  WHERE status = 'DELETED')
```

```{r}
count_batch                <- as.numeric(count_batch$`COUNT(*)`)
count_entity               <- as.numeric(count_entity$`COUNT(*)`)
count_transactions         <- as.numeric(count_transactions$`COUNT(*)`)
count_deleted_batches      <- as.numeric(count_deleted_batches$`COUNT(*)`)
count_deleted_transactions <-
  as.numeric(count_deleted_transactions$`COUNT(*)`)
```

## Information Schema Tables

### Table Names and Information

```{sql, connection = odbc_aws, output.var = "info_schema_tables"}
SELECT *
FROM information_schema.tables
```

### Data Size

```{sql, connection = odbc_aws, output.var = "info_schema_size"}
SELECT table_schema AS 'Database', 
       table_name AS 'Table',
       ROUND(((DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024), 2) AS 'Size in MB'
FROM information_schema.tables
ORDER BY (DATA_LENGTH + INDEX_LENGTH) DESC
```

```{r}
data_size_in_Mb <- round(sum(info_schema_size$`Size in MB`))
```

## Indexes

Create an index (permission to do so is currently denied):

```{sql, connection = odbc_aws}
CREATE INDEX transaction_batchid
ON transaction (batch_id)
```

View indexed variables:

```{sql, connection = odbc_aws, output.var = "indexed_variables"}
SELECT DISTINCT table_name, index_name
FROM information_schema.statistics
WHERE table_schema = 'transparency'
```

```{sql, connection = odbc_aws, output.var = "index_batch"}
SHOW INDEX FROM batch
```

```{sql, connection = odbc_aws, output.var = "index_entity"}
SHOW INDEX FROM entity
```

```{sql, connection = odbc_aws, output.var = "index_transaction"}
SHOW INDEX FROM transaction
```

## R Object Size

```{r}
entity_transactions %>% 
  object.size() %>% 
  print(units = "auto")
```

## Close

```{r}
dbDisconnect(odbc_aws)
rm(list = ls())
```