---
title: "Entities with American Express as a Vendor"
author: "Michael Jensen"
output: html_notebook
---
# Program Description

**Purpose**

Identify the governments that have American Express as a vendor.

Given the nature of the credit card American Express offers governments, meaning that it is considered a personal credit card rather than a government or business card, there may be a higher risk of fraud. Thus, Auditor Dougall believes that there isn't a good reason for a government to use American Express.

**Input(s)**

```{r}
dsn_aws        <- "transpAWS"
dsn_salesforce <- "Salesforce"

# Insert the most recently archived fiscal year:
most_recent_archived_fy <- 2013
```

**Output(s)**



# Libraries and Data Sources

```{r}
library(odbc)
library(tidyverse)

odbc_aws        <- dbConnect(odbc::odbc(), dsn_aws)
odbc_salesforce <- dbConnect(odbc::odbc(), dsn_salesforce)
rm(dsn_aws, dsn_salesforce)
```

# Function Definitions

## Argument Definitions

```{r, eval=FALSE}

```

# Execution

```{r}
vendor <-
  dbGetQuery(
    odbc_aws,
    paste("
      SELECT
        entity.name      AS entity_name,
        vendor.entity_id AS entity_id,
        vendor.name      AS vendor_name,
        vendor.id        AS vendor_id
      FROM vendor
      LEFT JOIN entity
      ON vendor.entity_id = entity.id
      WHERE (
        LOWER(vendor.name) LIKE '%american express%' OR
        LOWER(vendor.name) LIKE '%amex%'             OR
        LOWER(vendor.name) LIKE '%am-ex%')
      AND (
        LOWER(vendor.name) NOT LIKE 'american express foundation'    AND
        LOWER(vendor.name) NOT LIKE '%american expression of dance%' AND
        LOWER(vendor.name) NOT LIKE 'alamexo'                        AND
        LOWER(vendor.name) NOT LIKE 'amexpo inc'                     AND
        LOWER(vendor.name) NOT LIKE 'banamex sa fideicomiso%'        AND
        LOWER(vendor.name) NOT LIKE 'dynamex operations west, inc'   AND
        LOWER(vendor.name) NOT LIKE 'jamex, inc')
      AND vendor.id IN (
        SELECT vendor_id
        FROM vendor_summary
        WHERE fiscal_year > 2013
        AND type IN (1, 2))"))

vendor_summary <-
  dbGetQuery(
    odbc_aws,
    paste("
      SELECT vendor_id, type, fiscal_year
      FROM vendor_summary
      WHERE fiscal_year > ", most_recent_archived_fy, "
      AND type IN (1, 2)"))

amex_is_vendor <- 
  vendor %>%
  left_join(vendor_summary, by = "vendor_id") %>% 
  select(entity_name, fiscal_year, vendor_name, type, entity_id, vendor_id) %>% 
  arrange(entity_name, fiscal_year)

distinct_vendors <-
  amex_is_vendor %>%
  distinct(vendor_name)

distinct_entities <-
  amex_is_vendor %>%
  distinct(entity_name)
```

```{r}
file_path <-
  "S:/Localgov/LG Compliance/Transparency Compliance/"

amex_is_vendor %>% 
  write_csv(
    path = paste0(file_path, Sys.Date(), " Vendor is AMEX.csv"),
      na = "")
```

# DBMS Disconnection

```{r}
dbDisconnect()
```