---
title: "Browse AWS Transparency Data"
author: "Michael Jensen"
date: "January 2019"
output: html_notebook
---
# Packages, Data Connection, and Input

```{r}
library(lubridate)
library(odbc)
library(scales)
library(tidyverse)

odbc_aws <- dbConnect(odbc::odbc(), "transpAWS")
```

# Browse Transparency Data

## Entity Table

```{sql, connection=odbc_aws, output.var="entity_table"}
SELECT name, id
FROM entity
```

```{r}
t_id <- 427

rm(entity_table)
```

```{sql, connection=odbc_aws, output.var="entity_table"}
SELECT 
  name,
  govt_lvl,
  fiscal_period,
  payroll_period
FROM entity
WHERE id = ?t_id
```

## Batch Table

```{sql, connection=odbc_aws, output.var="batch_table"}
SELECT 
  id,
  upload_date,
  processed_date,
  file_record_count,
  file_total_amount,
  begin_txn_date,
  end_txn_date,
  status,
  status_message
FROM batch
WHERE entity_id = ?t_id
ORDER BY upload_date DESC
```

```{sql, connection=odbc_aws, output.var="batch_table_status_options"}
SELECT DISTINCT status
FROM batch
```

## Transaction Tables

**Remember**

Transactions for the current and previous four fiscal years are stored in the 
transaction table. The remaining years are stored in separate tables (e.g., 
transaction_2009).

```{sql, connection=odbc_aws, output.var="transaction_table"}
SELECT *
FROM transaction
WHERE batch_id IN (
  SELECT id
  FROM batch
  WHERE entity_id = ?t_id)
```

## Transaction Group Table

```{sql, connection=odbc_aws, output.var="transaction_group"}
SELECT *
FROM transaction_group
```

## Summary Table

**Remember**

The information in the Summary Table is for summarizing transactions by org, 
cat, fund, program, and function. It is not for summarizing data by fiscal year
(do that using the Transaction Table).

```{sql, connection=odbc_aws, output.var="summary_table"}
SELECT *
FROM summary
WHERE entity_id = ?t_id
```

## Vendor Table

**Remember**

The Vendor Table contains all vendors uploaded to Transparency, which means that
it contains vendors that have been deleted. The Vendor Summary Table contains 
current information.

```{sql, connection=odbc_aws, output.var="vendor_table"}
SELECT *
FROM vendor
WHERE entity_id = ?t_id
```

## Vendor Summary Table

```{sql, connection=odbc_aws, output.var="vendor_summary_table"}
SELECT *
FROM vendor_summary
WHERE entity_id = ?t_id
```

# Browse Transparency Metadata

## Table Row Counts

```{sql, connection = odbc_aws, output.var = "count_batch"}
SELECT COUNT(*) FROM batch
```

```{sql, connection = odbc_aws, output.var = "count_entity"}
SELECT COUNT(*)
FROM entity
```

```{sql, connection = odbc_aws, output.var = "count_transactions"}
SELECT COUNT(*) FROM transaction
```

```{sql, connection = odbc_aws, output.var = "count_deleted_batches"}
SELECT COUNT(*) FROM batch WHERE status = 'DELETED'
```

```{sql, connection = odbc_aws, output.var = "count_deleted_transactions"}
SELECT COUNT(*) 
FROM transaction 
WHERE batch_id IN (
  SELECT id
  FROM batch
  WHERE status = 'DELETED')
```

```{r}
count_batch                <- as.numeric(count_batch$`COUNT(*)`)
count_entity               <- as.numeric(count_entity$`COUNT(*)`)
count_transactions         <- as.numeric(count_transactions$`COUNT(*)`)
count_deleted_batches      <- as.numeric(count_deleted_batches$`COUNT(*)`)
count_deleted_transactions <-
  as.numeric(count_deleted_transactions$`COUNT(*)`)
```

## Information Schema Tables

### Table Names and Information

```{sql, connection = odbc_aws, output.var = "info_schema_tables"}
SELECT *
FROM information_schema.tables
```

```{sql, connection=odbc_aws, output.var=transparency_table_names}
SELECT TABLE_NAME
FROM information_schema.tables
WHERE TABLE_SCHEMA = "transparency"
```

### Data Size

```{sql, connection = odbc_aws, output.var = "info_schema_size"}
SELECT table_schema AS 'Database', 
       table_name AS 'Table',
       ROUND(((DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024), 2) AS 'Size in MB'
FROM information_schema.tables
ORDER BY (DATA_LENGTH + INDEX_LENGTH) DESC
```

```{r}
data_size_in_Mb <- round(sum(info_schema_size$`Size in MB`))
```

## Indexes

Create an index (permission to do so is currently denied):

```{sql, connection = odbc_aws}
CREATE INDEX transaction_batchid
ON transaction (batch_id)
```

View indexed variables:

```{sql, connection = odbc_aws, output.var = "indexed_variables"}
SELECT DISTINCT table_name, index_name
FROM information_schema.statistics
WHERE table_schema = 'transparency'
```

```{sql, connection = odbc_aws, output.var = "index_batch"}
SHOW INDEX FROM batch
```

```{sql, connection = odbc_aws, output.var = "index_entity"}
SHOW INDEX FROM entity
```

```{sql, connection = odbc_aws, output.var = "index_transaction"}
SHOW INDEX FROM transaction
```

## R Object Size

```{r}
entity_transactions %>% 
  object.size() %>% 
  print(units = "auto")
```

# Troubleshoot an Entity's Data

```{sql, connection=odbc_aws, output.var="entity_table"}
SELECT 
  entity.name   AS entity_name, 
  entity.id     AS transparency_id,
  entity.govt_lvl,
  entity.fiscal_period,
  entity.payroll_period,
  contact.name  AS contact_name,
  contact.email AS contact_email, 
  contact.phone AS contact_phone
FROM entity
JOIN contact
ON entity.primary_contact_id = contact.id
```

```{r}
t_id <- 1495

entity_table$transparency_id <- 
  entity_table$transparency_id %>% as.numeric()

entity_info <- 
  entity_table %>%
  filter(transparency_id == t_id)
```

```{sql, connection=odbc_aws, output.var="batch_table"}
SELECT 
  id,
  upload_date,
  processed_date,
  file_record_count,
  file_total_amount,
  begin_txn_date,
  end_txn_date,
  status,
  status_message
FROM batch
WHERE entity_id = ?t_id
ORDER BY upload_date DESC
```

```{sql, connection=odbc_aws, output.var="transaction_table"}
SELECT 
  posting_date,
  amount,
  batch_id,
  fiscal_year,
  description,
  type
FROM transaction
WHERE batch_id IN (
  SELECT id
  FROM batch
  WHERE entity_id = ?t_id)
```

```{r}
posting_dates_exp <- 
  transaction_table %>% 
  filter(type == 1) %>% 
  .$posting_date %>% 
  floor_date() %>% 
  unique() %>% 
  as.character() %>% 
  as.matrix()

posting_dates_rev <- 
  transaction_table %>% 
  filter(type == 2) %>% 
  .$posting_date %>% 
  floor_date() %>% 
  unique() %>% 
  as.character() %>% 
  as.matrix()

posting_dates_w2 <- 
  transaction_table %>% 
  filter(type == 3) %>% 
  .$posting_date %>% 
  floor_date() %>% 
  unique() %>% 
  as.character() %>% 
  as.matrix()
```

# Close

```{r}
dbDisconnect(odbc_aws)
```